# ‚ö° –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: –ù–∞—Å—Ç–æ—è—â–∏–π –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º

## üîç –ü—Ä–æ–±–ª–µ–º–∞

–í—ã –±—ã–ª–∏ –ø—Ä–∞–≤—ã! –ö–æ–¥ —Ä–∞–±–æ—Ç–∞–ª **–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ**, –∞ –Ω–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ. 

### –ü—Ä–∏—á–∏–Ω–∞: Python GIL (Global Interpreter Lock)

`ThreadPoolExecutor` –Ω–µ –¥–∞–µ—Ç –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞ –¥–ª—è CPU-–∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á –∏–∑-–∑–∞ GIL.

```python
# –ë—ã–ª–æ (–ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ):
ThreadPoolExecutor  ‚Üí  –§—Ä–∞–≥–º–µ–Ω—Ç 1 ‚Üí –§—Ä–∞–≥–º–µ–Ω—Ç 2 ‚Üí –§—Ä–∞–≥–º–µ–Ω—Ç 3 ‚Üí –§—Ä–∞–≥–º–µ–Ω—Ç 4
                       (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –∏–∑-–∑–∞ GIL!)
```

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ `ProcessPoolExecutor` - –Ω–∞—Å—Ç–æ—è—â–∏–π –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º!

```python
# –°—Ç–∞–ª–æ (—Ä–∞–±–æ—Ç–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ):
ProcessPoolExecutor  ‚Üí  –§—Ä–∞–≥–º–µ–Ω—Ç 1 ‚îê
                        –§—Ä–∞–≥–º–µ–Ω—Ç 2 ‚îú‚îÄ‚îÄ –í—Å–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ!
                        –§—Ä–∞–≥–º–µ–Ω—Ç 3 ‚îÇ
                        –§—Ä–∞–≥–º–µ–Ω—Ç 4 ‚îò
```

## üß™ –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –®–∞–≥ 1: –¢–µ—Å—Ç –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ multiprocessing —Ä–∞–±–æ—Ç–∞–µ—Ç:

```bash
python test_multiprocessing_speedup.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
TEST 1: –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê
   –í—Ä–µ–º—è: 8.00s

TEST 2: ThreadPoolExecutor (GIL)
   –í—Ä–µ–º—è: ~8.00s  ‚ùå –ù–µ—Ç —É—Å–∫–æ—Ä–µ–Ω–∏—è!

TEST 3: ProcessPoolExecutor
   –í—Ä–µ–º—è: ~2.00s  ‚úÖ –£—Å–∫–æ—Ä–µ–Ω–∏–µ 4x!
```

### –®–∞–≥ 2: –†–µ–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–∞

```bash
python run_parallel_voice.py data/content/audio/input.mp3 output.mp3 --parallel
```

**–ß—Ç–æ –≤—ã —É–≤–∏–¥–∏—Ç–µ:**
- –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- –†–µ–∞–ª—å–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ 2-4x

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

| CPU —è–¥–µ—Ä | –ú–µ—Ç–æ–¥ | –í—Ä–µ–º—è | –£—Å–∫–æ—Ä–µ–Ω–∏–µ |
|----------|-------|-------|-----------|
| 4 | Sequential | 120s | 1x (baseline) |
| 4 | ThreadPool (—Å—Ç–∞—Ä–æ–µ) | ~120s | ‚ùå 1.0x |
| 4 | ProcessPool (–Ω–æ–≤–æ–µ) | ~35s | ‚úÖ 3.4x |

## üîß –ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ

### 1. `parallel_voice_processor.py`

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ Worker —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è multiprocessing
- ‚úÖ `ProcessPoolExecutor` –≤–º–µ—Å—Ç–æ `ThreadPoolExecutor`
- ‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–º–µ—Å—Ç–æ —Ñ—É–Ω–∫—Ü–∏–π (–¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π context –¥–ª—è spawn

**–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
# –ù–æ–≤–∞—è worker —Ñ—É–Ω–∫—Ü–∏—è (–º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ)
def _process_chunk_worker(chunk_info, processor_params, output_dir):
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª–∏ –≤ –∫–∞–∂–¥–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ
    from core.utils.silero_voice_changer import SileroVoiceChanger
    voice_changer = SileroVoiceChanger(...)
    return voice_changer.convert_voice(...)

# ProcessPoolExecutor —Å spawn context
ctx = mp.get_context('spawn')
with ProcessPoolExecutor(max_workers=N, mp_context=ctx) as executor:
    ...
```

### 2. `voice_changer.py`

**–ò–∑–º–µ–Ω–µ–Ω–æ:**
- ‚úÖ –ü–µ—Ä–µ–¥–∞—á–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤–º–µ—Å—Ç–æ —Ñ—É–Ω–∫—Ü–∏–π
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `use_processes=True`
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ "MULTIPROCESSING"

**–ë—ã–ª–æ:**
```python
def process_chunk(input, output):
    return self.silero_changer.convert_voice(...)

parallel_processor.process_chunks_parallel(chunks, process_chunk)
```

**–°—Ç–∞–ª–æ:**
```python
processor_params = {
    'voice': 'kseniya',
    'sample_rate': 48000,
    'preserve_prosody': False,
    'device': 'cpu'
}

parallel_processor.process_chunks_parallel(
    chunks, 
    processor_params=processor_params,
    use_processes=True  # ‚Üê –ù–∞—Å—Ç–æ—è—â–∏–π –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º!
)
```

## üíª –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–∞–∫ –æ–±—ã—á–Ω–æ!

```bash
# Multiprocessing –≤–∫–ª—é—á–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
python run_parallel_voice.py input.mp3 output.mp3 --parallel
```

–ò–ª–∏ –∏–∑ –∫–æ–¥–∞:

```python
from core.utils.voice_changer import VoiceChanger

# Multiprocessing –≤–∫–ª—é—á–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
changer = VoiceChanger(
    enable_parallel=True,
    chunk_duration_minutes=5,
    max_workers=4
)

result = changer.process_file(
    input_file='input.mp3',
    output_file='output.mp3',
    method='silero',
    voice_model='kseniya'
)

changer.cleanup()
```

## üéØ –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π —Å–ø–∏—Å–æ–∫

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã –≤ —Å–ª–µ–¥—É—é—â–µ–º –ø–æ—Ä—è–¥–∫–µ:

- [ ] 1. **–¢–µ—Å—Ç –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞**: `python test_multiprocessing_speedup.py`
  - –î–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å —É—Å–∫–æ—Ä–µ–Ω–∏–µ 2-4x –¥–ª—è ProcessPool
  
- [ ] 2. **–ü—Ä–æ—Å—Ç–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**: `python run_parallel_voice.py input.mp3 output.mp3`
  - –î–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
  
- [ ] 3. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**: `python run_parallel_voice.py input.mp3 output.mp3 --parallel --chunks 3`
  - –î–æ–ª–∂–Ω–∞ –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∞–ª—å–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ

- [ ] 4. **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏**:
  ```bash
  # –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
  time python run_parallel_voice.py input.mp3 out1.mp3 --no-parallel
  
  # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
  time python run_parallel_voice.py input.mp3 out2.mp3 --parallel
  ```
  - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ 2-4 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ!

## üìà –û–∂–∏–¥–∞–µ–º–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ

–ù–∞ –≤–∞—à–µ–º 4-—è–¥–µ—Ä–Ω–æ–º CPU:

| –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞—É–¥–∏–æ | –§—Ä–∞–≥–º–µ–Ω—Ç—ã | –ü—Ä–æ—Ü–µ—Å—Å—ã | –£—Å–∫–æ—Ä–µ–Ω–∏–µ |
|-------------------|-----------|----------|-----------|
| 5 –º–∏–Ω | 1 | - | 1x (–Ω–µ—Ç —Å–º—ã—Å–ª–∞) |
| 10 –º–∏–Ω | 2 | 2 | ~1.8x |
| 20 –º–∏–Ω | 4 | 4 | ~3.2x |
| 40 –º–∏–Ω | 8 | 4 | ~3.5x |

## üêõ –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –û—à–∏–±–∫–∞ "Can't pickle"

**–ü—Ä–∏—á–∏–Ω–∞**: –°—Ç–∞—Ä—ã–π –∫–æ–¥ –ø—ã—Ç–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é

**–†–µ—à–µ–Ω–∏–µ**: –û–±–Ω–æ–≤–ª–µ–Ω –∫–æ–¥, —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

### 2. –í—Å–µ –µ—â–µ –º–µ–¥–ª–µ–Ω–Ω–æ

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
```bash
# –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è multiprocessing
python test_multiprocessing_speedup.py
```

–ï—Å–ª–∏ ProcessPoolExecutor –º–µ–¥–ª–µ–Ω–Ω—ã–π:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ CPU: `python -c "import os; print(os.cpu_count())"`
- –£–≤–µ–ª–∏—á—å—Ç–µ —Ä–∞–∑–º–µ—Ä —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤: `--chunks 10`

### 3. –û—à–∏–±–∫–∏ –∏–º–ø–æ—Ä—Ç–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö

**–ü—Ä–∏—á–∏–Ω–∞**: –ú–æ–¥—É–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –¥–æ—á–µ—Ä–Ω–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö

**–†–µ—à–µ–Ω–∏–µ**: –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ PYTHONPATH –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ**: `MULTIPROCESSING_FIX.md`
- **–¢–µ—Å—Ç**: `test_multiprocessing_speedup.py`
- **CLI**: `CLI_USAGE.md`

## ‚úÖ –ò—Ç–æ–≥–∏

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚ùå ThreadPoolExecutor
- ‚ùå GIL –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º
- ‚ùå –†–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
- ‚ùå –ù–µ—Ç —É—Å–∫–æ—Ä–µ–Ω–∏—è

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚úÖ ProcessPoolExecutor
- ‚úÖ –û–±—Ö–æ–¥ GIL —á–µ—Ä–µ–∑ –ø—Ä–æ—Ü–µ—Å—Å—ã
- ‚úÖ –ù–∞—Å—Ç–æ—è—â–∏–π –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º
- ‚úÖ –£—Å–∫–æ—Ä–µ–Ω–∏–µ 2-4x

---

**–¢–µ–ø–µ—Ä—å —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ! üöÄ**

